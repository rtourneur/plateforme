---
# tasks file for mysql

- name: erase mysql data directory
  file:
    path: "{{mysql_data_home_dir}}/{{env}}/{{component_name}}"
    state: absent
  tags: [mysqlComponent]
  when: database.erase_data_directory == "true"
  
- name: create mysql data directory
  file:
    path: "{{mysql_data_home_dir}}/{{env}}/{{component_name}}"
    state: directory
  tags: [mysqlComponent]

# copy database script, and execute it agains the database server
- name: copy mysql database script
  command: cp {{project_home_dir}}/{{item}} {{mysql_data_home_dir}}/{{env}}/{{component_name}}/ creates="{{mysql_data_home_dir}}/{{env}}/{{component_name}}/{{item}}"
  with_items: "{{database.scripts}}"
  tags: [mysqlComponent]
  # user 'notify' to trigger the execution of the Sql script
  notify:
  - execute mysql database script

- name: start mysql container
  docker:
    name: "{{component_name}}_{{env}}"
    image: "{{image}}"
    state: started
    ports:
    - "{{ports.mysql.host}}:{{ports.mysql.container}}"
    env:
      MYSQL_ROOT_PASSWORD: "{{database.password}}"
    volumes:
    - "{{mysql_data_home_dir}}/{{env}}/{{component_name}}:/var/lib/mysql"
    docker_api_version: 1.18
  tags: [mysqlComponent]
  notify:
  - wait mysql initialisation
